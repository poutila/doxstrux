name: Verify Render Synchronization

on:
  push:
    branches: [main, develop]
  pull_request:

jobs:
  verify-render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Re-render from YAML
        run: python tools/render_task_templates.py --strict

      - name: Validate task and gate IDs
        run: python tools/validate_task_ids.py

      - name: Validate command safety
        run: python tools/validate_commands.py

      - name: Validate artifact paths
        run: python tools/sanitize_paths.py

      - name: Check SHA256 synchronization
        run: |
          set -euo pipefail
          YAML_SHA=$(sha256sum DETAILED_TASK_LIST_template.yaml | awk '{print $1}')
          JSON_SHA=$(python - <<'PY'
import json
from pathlib import Path
print(json.loads(Path('DETAILED_TASK_LIST_template.json').read_text()).get('render_meta', {}).get('sha256_of_yaml', ''))
PY
)
          if [ -z "$JSON_SHA" ]; then
            echo "❌ Missing render_meta.sha256_of_yaml in JSON"
            exit 1
          fi
          if [ "$YAML_SHA" != "$JSON_SHA" ]; then
            echo "❌ SHA256 mismatch - JSON out of sync"
            echo "YAML: $YAML_SHA"
            echo "JSON: $JSON_SHA"
            exit 1
          fi

      - name: Check for uncommitted changes
        run: |
          if ! git diff --exit-code DETAILED_TASK_LIST_template.json DETAILED_TASK_LIST_template.md; then
            echo "❌ Rendered files have uncommitted changes"
            echo "Run: python tools/render_task_templates.py --strict"
            exit 1
          fi

      - name: Scan for placeholder leakage
        run: |
          if grep -E '\{\{[^}]+\}\}' DETAILED_TASK_LIST_template.json DETAILED_TASK_LIST_template.md; then
            echo "❌ Unresolved placeholders detected"
            exit 1
          fi
