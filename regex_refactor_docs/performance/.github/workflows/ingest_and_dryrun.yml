name: Audit Ingest & Dry-Run (ingest gate)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */6 * * *'  # every 6 hours

jobs:
  ingest_and_dryrun:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pyyaml || true

      - name: Validate consumer artifacts (ingest gate - ENFORCED)
        run: |
          mkdir -p adversarial_reports
          if [ -f adversarial_reports/consumer_artifact.json ]; then
            # Schema validation (always required)
            python tools/validate_consumer_art.py --artifact adversarial_reports/consumer_artifact.json || exit 2

            # HMAC verification (if policy requires)
            if [ "${POLICY_REQUIRE_HMAC:-false}" = "true" ]; then
              python tools/validate_consumer_art.py \
                --artifact adversarial_reports/consumer_artifact.json \
                --require-hmac || exit 3
            fi
          else
            echo "No consumer artifact found - skipping artifact validation"
          fi

      - name: Dry-run create issues (ingest -> central backlog)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK || '' }}
        run: |
          python tools/create_issues_for_unregistered_hits.py \
              --audit adversarial_reports/audit_summary.json \
              --dry-run || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: audit-artifacts
          path: adversarial_reports/*
