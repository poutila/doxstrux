name: Pre-merge Safety Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  REPORT_DIR: adversarial_reports
  AUDIT_REPORT: adversarial_reports/pr_audit.json

jobs:
  premerge_checks:
    name: Pre-merge safety checks (platform assertion + baseline audit)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests || true

      - name: Ensure report dir exists
        run: mkdir -p ${{ env.REPORT_DIR }}

      - name: Platform assertion (Linux-only)
        run: |
          echo "Asserting runner platform is Linux..."
          python - <<'PY'
import platform, sys
if platform.system() != "Linux":
    print("Platform assertion failed: not Linux (found {})".format(platform.system()))
    sys.exit(2)
print("Platform assertion OK: Linux")
PY

      - name: Run fast adversarial smoke (PR velocity)
        run: |
          if [ -f tools/run_adversarial.py ] && [ -f adversarial_corpora/fast_smoke.json ]; then
            python tools/run_adversarial.py adversarial_corpora/fast_smoke.json --runs 1 --report adversarial_reports/pr_adv_smoke.json || true
            echo "Fast smoke adversarial tests completed"
          else
            echo "Fast smoke tests skipped (tools/run_adversarial.py or adversarial_corpora/fast_smoke.json not found)"
          fi

      - name: Verify baseline signature (KMS or GPG)
        env:
          BASELINE_PUBLIC_KEY: ${{ secrets.BASELINE_PUBLIC_KEY || '' }}
          AWS_KMS_KEY_ID: ${{ secrets.AWS_KMS_KEY_ID || '' }}
        run: |
          # Try KMS verification first (production)
          if [ -n "${AWS_KMS_KEY_ID}" ] && [ -f baselines/metrics_baseline_v1.json.sig ]; then
            echo "Verifying baseline signature with AWS KMS..."
            aws kms verify \
              --key-id "${AWS_KMS_KEY_ID}" \
              --message fileb://baselines/metrics_baseline_v1.json \
              --message-type RAW \
              --signing-algorithm RSASSA_PKCS1_V1_5_SHA_256 \
              --signature fileb://baselines/metrics_baseline_v1.json.sig
            echo "✓ KMS signature verification passed"
          # Fallback to GPG verification (local dev)
          elif [ -n "${BASELINE_PUBLIC_KEY}" ]; then
            echo "Verifying baseline signature with GPG..."
            echo "${BASELINE_PUBLIC_KEY}" > /tmp/baseline_pub.asc
            sudo apt-get update -y && sudo apt-get install -y gnupg
            gpg --import /tmp/baseline_pub.asc
            rm -f /tmp/baseline_pub.asc
            gpg --batch --verify baselines/metrics_baseline_v1.json.asc baselines/metrics_baseline_v1.json
            echo "✓ GPG signature verification passed"
          else
            echo "ERROR: Neither AWS_KMS_KEY_ID nor BASELINE_PUBLIC_KEY secret is set. Baseline signature verification cannot run."
            exit 2
          fi

      - name: Run audit greenlight (baseline + branch-protection + discovery)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          python tools/audit_greenlight.py --report "${{ env.AUDIT_REPORT }}"
          echo "Audit report written to ${{ env.AUDIT_REPORT }}"
          cat "${{ env.AUDIT_REPORT }}"

      - name: Upload audit report artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-audit-report
          path: ${{ env.AUDIT_REPORT }}
          retention-days: 90

      - name: Fail if audit non-zero
        run: |
          echo "Audit completed - check artifact for details"
