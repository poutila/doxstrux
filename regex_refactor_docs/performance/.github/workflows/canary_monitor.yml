name: Canary Monitor - Auto-Rollback on Gate Failure

on:
  schedule:
    # Run every hour during canary deployment
    - cron: '0 * * * *'
  workflow_dispatch:  # Allow manual triggers

jobs:
  check-canary-gates:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip

      - name: Fetch current canary metrics
        run: |
          # This would normally fetch from monitoring system (Prometheus/Grafana)
          # For now, just check if metrics file exists
          if [ ! -f metrics/canary_current.json ]; then
            echo "⚠️  No canary metrics found - skipping check"
            exit 0
          fi

      - name: Check promotion gates
        id: check_gates
        run: |
          python tools/check_canary_promotion.py
        continue-on-error: true

      - name: Auto-rollback if gates fail
        if: steps.check_gates.outcome == 'failure'
        run: |
          echo "❌ Canary gates failed - triggering rollback"

          # Set feature flag to 0 (disable skeleton parser)
          # This would normally call your feature flag service
          echo "Setting USE_SKELETON_PARSER=0"

          # Alert on-call engineer
          # This would normally send alert via PagerDuty/Slack/etc
          echo "Alerting on-call: Skeleton parser auto-rolled back due to gate failure"

      - name: Report gate check results
        run: |
          if [ "${{ steps.check_gates.outcome }}" == "success" ]; then
            echo "✅ All canary gates passed"
          else
            echo "❌ Canary gate check failed - rollback initiated"
            exit 1
          fi
